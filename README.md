# ðŸ”„ Sistema de Failover para Flutter

<div align="center">

<img src="assets/logo.svg" width="120" height="120" alt="Failover Logo">

![Failover](https://img.shields.io/badge/Failover-1.0.0-blue?style=for-the-badge&logo=dart)
![Flutter](https://img.shields.io/badge/Flutter-3.0+-blue?style=for-the-badge&logo=flutter)
![License](https://img.shields.io/badge/License-MIT-green?style=for-the-badge)

**Um sistema robusto e flexÃ­vel para gerenciar failover entre diferentes ambientes (produÃ§Ã£o, desenvolvimento, staging) em aplicaÃ§Ãµes Flutter.**

[![Pub](https://img.shields.io/pub/v/failover.svg)](https://pub.dev/packages/failover)
[![Pub Points](https://img.shields.io/pub/points/failover)](https://pub.dev/packages/failover/score)
[![Popularity](https://img.shields.io/pub/popularity/failover)](https://pub.dev/packages/failover/score)

</div>

## CaracterÃ­sticas

- âœ… **Gerenciamento de Ambientes**: Suporte para produÃ§Ã£o, desenvolvimento e staging
- âœ… **ConfiguraÃ§Ãµes DinÃ¢micas**: Cada ambiente pode ter configuraÃ§Ãµes especÃ­ficas
- âœ… **Health Check AutomÃ¡tico**: VerificaÃ§Ã£o periÃ³dica da saÃºde dos ambientes
- âœ… **Fallback AutomÃ¡tico**: AlternÃ¢ncia automÃ¡tica entre ambientes em caso de falha
- âœ… **Listeners**: Sistema de notificaÃ§Ã£o para mudanÃ§as de ambiente
- âœ… **HTTP Helper**: UtilitÃ¡rio para requisiÃ§Ãµes HTTP com fallback automÃ¡tico
- âœ… **Singleton Pattern**: InstÃ¢ncia Ãºnica para toda a aplicaÃ§Ã£o
- âœ… **Timeout ConfigurÃ¡vel**: Timeouts especÃ­ficos para cada ambiente

## InstalaÃ§Ã£o

Adicione a dependÃªncia ao seu `pubspec.yaml`:

```yaml
dependencies:
  failover: ^0.0.1
```

## Uso BÃ¡sico

### 1. InicializaÃ§Ã£o

```dart
import 'package:failover/failover.dart';

void main() async {
  // Inicializa o sistema com ambiente padrÃ£o
  await FailoverHelper.initialize(
    initialEnvironment: Environment.development,
  );
  
  runApp(MyApp());
}
```

### 2. ConfiguraÃ§Ãµes Customizadas

```dart
// ConfiguraÃ§Ãµes personalizadas para cada ambiente
final customConfigs = {
  Environment.production: EnvironmentConfig(
    apiUrl: 'https://api.meuapp.com',
    apiKey: 'minha_chave_producao',
    firebaseToken: 'firebase_token_producao', // Opcional
    customAuthHeader: 'X-Custom-Auth', // Header personalizado
    enableLogging: false,
    enableAnalytics: true,
    timeout: Duration(seconds: 30),
    maxRetries: 3,
    authType: AuthType.both, // Aceita API Key e Firebase
  ),
  Environment.development: EnvironmentConfig(
    apiUrl: 'https://api-dev.meuapp.com',
    apiKey: 'minha_chave_desenvolvimento',
    firebaseToken: null,
    customAuthHeader: 'X-Dev-Key', // Header personalizado para dev
    enableLogging: true,
    enableAnalytics: false,
    timeout: Duration(seconds: 10),
    maxRetries: 1,
    authType: AuthType.apiKey, // SÃ³ API Key
  ),
  Environment.staging: EnvironmentConfig(
    apiUrl: 'https://api-staging.meuapp.com',
    apiKey: 'minha_chave_staging',
    firebaseToken: 'firebase_token_staging',
    customAuthHeader: 'X-Staging-Token', // Header personalizado para staging
    enableLogging: true,
    enableAnalytics: true,
    timeout: Duration(seconds: 20),
    maxRetries: 2,
    authType: AuthType.firebase, // SÃ³ Firebase
  ),
};
```

await FailoverHelper.initialize(
  initialEnvironment: Environment.development,
  customConfigs: customConfigs,
);
```

### 3. RequisiÃ§Ãµes HTTP com Fallback

```dart
// RequisiÃ§Ã£o GET simples
try {
  final response = await FailoverHelper.httpRequest(
    endpoint: '/users',
    method: 'GET',
  );
  
  if (response.statusCode == 200) {
    final data = await response.transform(utf8.decoder).join();
    print('Dados recebidos: $data');
  }
} catch (e) {
  print('Erro na requisiÃ§Ã£o: $e');
}

// RequisiÃ§Ã£o POST com dados
try {
  final response = await FailoverHelper.httpRequest(
    endpoint: '/users',
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: jsonEncode({'name': 'JoÃ£o', 'email': 'joao@email.com'}),
  );
} catch (e) {
  print('Erro na requisiÃ§Ã£o: $e');
}
```

### 4. AlternÃ¢ncia Manual de Ambiente

```dart
// Alterna para produÃ§Ã£o
final success = await FailoverHelper.switchTo(Environment.production);
if (success) {
  print('Ambiente alterado para produÃ§Ã£o');
} else {
  print('Falha ao alterar ambiente');
}

// ObtÃ©m o ambiente atual
final currentEnv = FailoverHelper.currentEnvironment;
print('Ambiente atual: $currentEnv');
```

### 5. Listeners para MudanÃ§as de Ambiente

```dart
// Adiciona um listener para mudanÃ§as de ambiente
FailoverHelper.onEnvironmentChanged((Environment newEnvironment) {
  print('Ambiente alterado para: $newEnvironment');
  
  // Atualiza a UI ou reconecta serviÃ§os
  if (newEnvironment == Environment.production) {
    // ConfiguraÃ§Ãµes especÃ­ficas para produÃ§Ã£o
  } else if (newEnvironment == Environment.development) {
    // ConfiguraÃ§Ãµes especÃ­ficas para desenvolvimento
  }
});
```

### 6. OperaÃ§Ãµes Customizadas com Fallback

```dart
final manager = FailoverManager();

final result = await manager.executeWithFallback(
  operation: (config) async {
    // Sua operaÃ§Ã£o customizada aqui
    final client = HttpClient();
    final request = await client.getUrl(
      Uri.parse('${config.apiUrl}/custom-endpoint'),
    );
    request.headers.set('Authorization', 'Bearer ${config.apiKey}');
    
    final response = await request.close();
    client.close();
    return response;
  },
  fallbackOrder: [
    Environment.production,
    Environment.staging,
    Environment.development,
  ],
  timeout: Duration(seconds: 15),
);
```

### 7. VerificaÃ§Ã£o de SaÃºde dos Ambientes

```dart
// Verifica a saÃºde de todos os ambientes
final healthStatus = await manager.checkAllEnvironments();
healthStatus.forEach((environment, isHealthy) {
  print('$environment: ${isHealthy ? "SaudÃ¡vel" : "NÃ£o saudÃ¡vel"}');
});

// ObtÃ©m estatÃ­sticas do sistema
final stats = FailoverHelper.getStats();
print('EstatÃ­sticas: $stats');
```

## Estrutura da API

### EnvironmentConfig

```dart
class EnvironmentConfig {
  final String apiUrl;        // URL base da API
  final String apiKey;        // Chave de autenticaÃ§Ã£o
  final String? firebaseToken; // Token Firebase (opcional)
  final String? customAuthHeader; // Nome personalizado do header (opcional)
  final bool enableLogging;   // Habilita logs
  final bool enableAnalytics; // Habilita analytics
  final Duration timeout;     // Timeout para requisiÃ§Ãµes
  final int maxRetries;       // NÃºmero mÃ¡ximo de tentativas
  final AuthType authType;    // Tipo de autenticaÃ§Ã£o
}
```

### Tipos de AutenticaÃ§Ã£o

O sistema suporta **3 tipos de autenticaÃ§Ã£o**:

#### **1. API Key (`AuthType.apiKey`)**
```dart
// Usa header: x-api-key: sua_chave_aqui
EnvironmentConfig(
  apiKey: 'sua_api_key',
  authType: AuthType.apiKey,
)
```

#### **2. Firebase Token (`AuthType.firebase`)**
```dart
// Usa header: Authorization: Bearer seu_token_firebase
EnvironmentConfig(
  firebaseToken: 'seu_firebase_token',
  authType: AuthType.firebase,
)
```

#### **3. Ambos (`AuthType.both`)**
```dart
// Tenta Firebase primeiro, depois API Key
EnvironmentConfig(
  apiKey: 'sua_api_key',
  firebaseToken: 'seu_firebase_token',
  authType: AuthType.both,
)
```

### Headers de AutenticaÃ§Ã£o

O sistema automaticamente aplica os headers corretos baseado na configuraÃ§Ã£o:

#### **Headers PadrÃ£o:**
- **API Key:** `x-api-key: sua_chave`
- **Firebase:** `Authorization: Bearer seu_token`
- **Ambos:** Prioriza Firebase, fallback para API Key

#### **Headers Personalizados:**
VocÃª pode definir nomes personalizados para os headers de autenticaÃ§Ã£o:

```dart
EnvironmentConfig(
  apiKey: 'sua_chave',
  customAuthHeader: 'X-Custom-Auth', // Em vez de 'x-api-key'
  authType: AuthType.apiKey,
)

EnvironmentConfig(
  firebaseToken: 'seu_token',
  customAuthHeader: 'X-Firebase-Token', // Em vez de 'Authorization'
  authType: AuthType.firebase,
)
```

#### **Exemplos de Headers Personalizados:**
- `X-API-Key: sua_chave`
- `X-Custom-Token: seu_token`
- `X-Auth-Header: sua_chave`
- `X-Service-Key: sua_chave`
- `X-Client-Token: seu_token`

### FailoverManager

- `initialize()`: Inicializa o sistema
- `switchEnvironment()`: Alterna para um ambiente especÃ­fico
- `executeWithFallback()`: Executa operaÃ§Ã£o com fallback automÃ¡tico
- `checkAllEnvironments()`: Verifica saÃºde de todos os ambientes
- `addListener()`: Adiciona listener para mudanÃ§as
- `getStats()`: ObtÃ©m estatÃ­sticas do sistema

### FailoverHelper

- `initialize()`: InicializaÃ§Ã£o simplificada
- `httpRequest()`: RequisiÃ§Ãµes HTTP com fallback
- `switchTo()`: AlternÃ¢ncia de ambiente
- `onEnvironmentChanged()`: Adiciona listener
- `getStats()`: EstatÃ­sticas do sistema

## Exemplo Completo

```dart
import 'package:failover/failover.dart';
import 'package:flutter/material.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // Inicializa o sistema de failover
  await FailoverHelper.initialize(
    initialEnvironment: Environment.development,
  );
  
  // Adiciona listener para mudanÃ§as de ambiente
  FailoverHelper.onEnvironmentChanged((Environment env) {
    print('Ambiente alterado para: $env');
  });
  
  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Failover Demo',
      home: FailoverDemoPage(),
    );
  }
}

class FailoverDemoPage extends StatefulWidget {
  @override
  _FailoverDemoPageState createState() => _FailoverDemoPageState();
}

class _FailoverDemoPageState extends State<FailoverDemoPage> {
  String _currentEnvironment = '';
  String _lastResponse = '';

  @override
  void initState() {
    super.initState();
    _updateEnvironmentInfo();
  }

  void _updateEnvironmentInfo() {
    setState(() {
      _currentEnvironment = FailoverHelper.currentEnvironment.name;
    });
  }

  Future<void> _testRequest() async {
    try {
      final response = await FailoverHelper.httpRequest(
        endpoint: '/test',
        method: 'GET',
      );
      
      final data = await response.transform(utf8.decoder).join();
      setState(() {
        _lastResponse = 'Status: ${response.statusCode}\nDados: $data';
      });
    } catch (e) {
      setState(() {
        _lastResponse = 'Erro: $e';
      });
    }
  }

  Future<void> _switchEnvironment(Environment env) async {
    final success = await FailoverHelper.switchTo(env);
    if (success) {
      _updateEnvironmentInfo();
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Ambiente alterado para ${env.name}')),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Sistema de Failover')),
      body: Padding(
        padding: EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            Card(
              child: Padding(
                padding: EdgeInsets.all(16.0),
                child: Column(
                  children: [
                    Text(
                      'Ambiente Atual: $_currentEnvironment',
                      style: Theme.of(context).textTheme.headline6,
                    ),
                    SizedBox(height: 16),
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                      children: [
                        ElevatedButton(
                          onPressed: () => _switchEnvironment(Environment.development),
                          child: Text('Dev'),
                        ),
                        ElevatedButton(
                          onPressed: () => _switchEnvironment(Environment.staging),
                          child: Text('Staging'),
                        ),
                        ElevatedButton(
                          onPressed: () => _switchEnvironment(Environment.production),
                          child: Text('Prod'),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ),
            SizedBox(height: 16),
            ElevatedButton(
              onPressed: _testRequest,
              child: Text('Testar RequisiÃ§Ã£o'),
            ),
            SizedBox(height: 16),
            Card(
              child: Padding(
                padding: EdgeInsets.all(16.0),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'Ãšltima Resposta:',
                      style: Theme.of(context).textTheme.subtitle1,
                    ),
                    SizedBox(height: 8),
                    Text(_lastResponse.isEmpty ? 'Nenhuma requisiÃ§Ã£o feita' : _lastResponse),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}
```

## ContribuiÃ§Ã£o

ContribuiÃ§Ãµes sÃ£o bem-vindas! Por favor, sinta-se Ã  vontade para:

1. Reportar bugs
2. Sugerir novas funcionalidades
3. Enviar pull requests
4. Melhorar a documentaÃ§Ã£o

## Autor

**Alexandre Lisboa**
- GitHub: [@Alexandrelisboa845](https://github.com/Alexandrelisboa845)
- RepositÃ³rio: [https://github.com/Alexandrelisboa845/failover](https://github.com/Alexandrelisboa845/failover)

## LicenÃ§a

Este projeto estÃ¡ licenciado sob a licenÃ§a MIT - veja o arquivo [LICENSE](LICENSE) para detalhes.
